# THIS CODE WAS AUTOGENERATED. DO NOT MODIFY THIS FILE DIRECTLY
# THE SOURCE CODE LIVES IN A DIFFERENT REPOSITORY:
#   - centralized-templates
# FILE STEWARD: @pleo-io/infrastructure-core


name: Delete feature branch
on:
  pull_request:
    types:
      - labeled
      - closed
concurrency: ci-${{ github.workflow }}-${{ github.ref }}

env:
  AWS_IAM_ROLE_TO_ASSUME: arn:aws:iam::${{vars.AWS_ACCOUNT_ID_PRODUCT_DEV}}:role/github/repository/${{ github.event.repository.name }}-github-actions
  RELEASE_NAME: "${{ github.event.repository.name }}-pr${{ github.event.pull_request.number }}"

jobs:
  delete-feature-branch:
    name: Delete feature branch
    timeout-minutes: 5
    if: (contains(github.event.pull_request.labels.*.name, 'feature-deploy-delete') && !contains(github.event.pull_request.labels.*.name, 'feature-deploy')) || github.event.action == 'closed'
    runs-on: ubuntu-latest-private
    permissions:
      id-token: write
      contents: read
    steps:
      # Build release name
      - name: Build release name
        id: release-name
        ## We rely on this only running on pull-requests, as per workflow 'on' field
        run: |
          release_name="${{ github.event.repository.name }}-pr${{ github.event.pull_request.number }}"
          echo "Release Name: ${release_name}"
          echo "release-name=${release_name}" >> "$GITHUB_OUTPUT"

      - name: Configure product-dev AWS credentials
        uses: aws-actions/configure-aws-credentials@b47578312673ae6fa5b5096b330d9fbac3d116df # v4.2.1
        with:
          role-to-assume: ${{ env.AWS_IAM_ROLE_TO_ASSUME }}
          role-session-name: GitHubActions
          aws-region: eu-west-1
          special-characters-workaround: true

      - name: Destroy bucket manifest
        run: |
          aws s3 rm s3://pleo-flux-feature-deployment.product-dev/${{ github.event.repository.name }}/${{ steps.release-name.outputs.release-name }}.yaml
