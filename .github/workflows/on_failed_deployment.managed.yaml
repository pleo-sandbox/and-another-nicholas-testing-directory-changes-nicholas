# THIS CODE WAS AUTOGENERATED. DO NOT MODIFY THIS FILE DIRECTLY
# THE SOURCE CODE LIVES IN A DIFFERENT REPOSITORY:
#   - centralized-templates
# FILE STEWARD: @pleo-io/team-devx,@pleo-io/infrastructure-core


name: Failed Deployment Dispatch
run-name: "Deployment Failed: [${{ github.event.client_payload.environment }}] commit ${{ github.event.client_payload.sha }}"
on:
  repository_dispatch:
    types:
      - deployment_failed

concurrency: ${{ github.workflow }}-${{ github.event.client_payload.environment }}

jobs:
  ## Post slack alert when deployment fails
  notify-in-slack:
    name: "Notify in Slack"
    runs-on: ubuntu-latest
    env:
      deploymentFailureNotificationSlackChannel: oncall-team-devx-new
    steps:
      - name: Alert in Slack when failed deployment
        uses: slackapi/slack-github-action@b0fa283ad8fea605de13dc3f449259339835fc52 # v2.1.0
        with:
          token: ${{ secrets.SLACK_BOT_TOKEN_FLUX }}
          method: "chat.postMessage"
          payload: |
            {
              "channel": ${{ env.deploymentFailureNotificationSlackChannel }},
              "text": "ðŸ”¥ Failed deployment ðŸ”¥ for application ${{ github.event.repository.name }} in ${{ github.event.client_payload.environment }} environment",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸ”¥ Failed deployment ðŸ”¥",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Application:*\n${{ github.event.repository.name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ github.event.client_payload.environment }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "block_id": "message",
                  "text": {
                    "type": "mrkdwn",
                    "text": "Check deployment logs in <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}| Github Actions :eyes:>"
                  }
                }
              ]
            }
