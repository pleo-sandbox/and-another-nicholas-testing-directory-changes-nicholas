# THIS CODE WAS AUTOGENERATED. DO NOT MODIFY THIS FILE DIRECTLY
# THE SOURCE CODE LIVES IN A DIFFERENT REPOSITORY:
#   - centralized-templates
# FILE STEWARD: @pleo-io/infrastructure-core


name: Trigger flux application registration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "The environment to register your application to."
        required: true
        default: "product-dev"
        type: choice
        options:
          - product-production
          - product-staging
          - product-dev
          - ai-production
          - cicd-production
          - data-integration-dev
          - data-integration-staging
          - data-integration-production
          - security-production
          - techops-production
          - techops-staging
          - tooling-production

jobs:
  trigger-registration:
    name: Trigger ${{ github.event.repository.name }} registration in flux-config
    env:
      FLUX_REGISTRATION_EVENT: "flux-register-application"
    runs-on: ubuntu-latest
    steps:
      - name: Get admin Github token
        id: get-admin-token
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2
        with:
          app-id: ${{ secrets.PLEO_GH_APP_TOKEN_SIGNER_APP_ID }}
          private-key: ${{ secrets.PLEO_GH_APP_TOKEN_SIGNER_PRIVATE_KEY }}

      - name: Invoke workflow - Repository Dispatch
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3
        with:
          token: ${{ steps.get-admin-token.outputs.token }}
          repository: pleo-io/flux-config
          event-type: ${{ env.FLUX_REGISTRATION_EVENT }}
          client-payload: '{"cluster_name": "${{ inputs.environment }}", "application": "${{ github.event.repository.name }}", "default_branch": "${{ github.event.repository.default_branch }}"}'
