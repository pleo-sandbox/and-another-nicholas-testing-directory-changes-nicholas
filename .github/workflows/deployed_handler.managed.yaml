# THIS CODE WAS AUTOGENERATED. DO NOT MODIFY THIS FILE DIRECTLY
# THE SOURCE CODE LIVES IN A DIFFERENT REPOSITORY:
#   - centralized-templates
# FILE STEWARD: @pleo-io/infrastructure-core


name: Environment promotions
on:
  repository_dispatch:
    types:
      - deployed

concurrency: ${{ github.workflow }}-${{ github.event.client_payload.environment }}

# This defines the promotion relationships for all moons
# If a deployed event is received for the "from" environment, then we will do promotion for the "to" environment
env:
  promotions: '[{"from": "product-staging", "to": "product-production"}]'

jobs:
  promotion-setup:
    name: Select environments for promotion
    runs-on: ubuntu-latest
    if: github.event.client_payload.trigger != 'manual'
    outputs:
      matrix: ${{steps.filtered_matrix.outputs.result}}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          ref: ${{ github.event.client_payload.image_tag }}

      - name: Find env with declared config
        id: environments
        run: |
          cd ./k8s
          # This list the directories in the k8s folder, each one represents an env
          # if the env folder exists, then we assume the config is provided for that env
          environments="$(ls -d -- */)"
          sanitized="$(echo "$environments" | tr '\n' ' ')"
          echo "value=$sanitized" >> "$GITHUB_OUTPUT"

      - uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        id: filtered_matrix
        with:
          script: |
            const promotions = ${{ env.promotions }}

            // This reformats the value of 'step.environments.outputs.value' from the following string "product-staging/ product-production/" to an array '["product-staging", "product-production"]'
            const configuredEnvironments = "${{ steps.environments.outputs.value }}"
              .trim()
              .split(" ")
              .map(env => env.replace('/', ''))

            return promotions
              .filter(({from: from, to: to}) =>  from == "${{ github.event.client_payload.environment }}")
              .filter(({from: from, to: to}) => {
                const isEnvironmentConfigured = configuredEnvironments.includes(to)

                if(!isEnvironmentConfigured){
                  console.log(`Skipping promotion to "${to}" since no directory was found at path "./k8s/${to}"`)
                }

                return isEnvironmentConfigured
              })
              .map(({from: from, to: to}) => to)

  promotion:
    needs: promotion-setup
    if: fromJSON(needs.promotion-setup.outputs.matrix)[0] != null
    strategy:
      matrix:
        promotion: ${{ fromJSON(needs.promotion-setup.outputs.matrix) }}
    uses: pleo-io/reusable-workflows/.github/workflows/update-image-tag.yaml@main
    with:
      environment: ${{ matrix.promotion }}
      image_tag: ${{ github.event.client_payload.image_tag }}
    secrets:
      application_id: ${{ secrets.PLEO_GH_APP_TOKEN_SIGNER_APP_ID }}
      application_private_key: ${{ secrets.PLEO_GH_APP_TOKEN_SIGNER_PRIVATE_KEY }}
