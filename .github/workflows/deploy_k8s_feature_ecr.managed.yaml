# THIS CODE WAS AUTOGENERATED. DO NOT MODIFY THIS FILE DIRECTLY
# THE SOURCE CODE LIVES IN A DIFFERENT REPOSITORY:
#   - centralized-templates
# FILE STEWARD: @pleo-io/infrastructure-core


name: Deploy feature branch
on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
concurrency: ci-${{ github.workflow }}-${{ github.ref }}

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  PRODUCT_DEV_AWS_IAM_ROLE_TO_ASSUME: arn:aws:iam::${{vars.AWS_ACCOUNT_ID_PRODUCT_DEV}}:role/github/repository/${{ github.event.repository.name }}-github-actions
  RELEASE_NAME: "${{ github.event.repository.name }}-pr${{ github.event.pull_request.number }}"
  REPO: ${{ github.event.repository.name }}
  CLUSTER: product-dev
  SUB_DOMAIN: dev.pleo.io

jobs:
  build-and-publish-image:
    name: Build and publish image
    if: contains(github.event.pull_request.labels.*.name, 'feature-deploy') && !contains(github.event.pull_request.labels.*.name, 'feature-deploy-delete')
    timeout-minutes: 20
    outputs:
      image-tag: ${{ steps.image-tag.outputs.result }}
    runs-on: ubuntu-latest-private
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      # Setup Buildx for Docker operations.
      - name: Setup Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Set up JDK 21
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          java-version: 21
          distribution: temurin

      # Allow caching Gradle executions to further speed up CI/CD steps invoking Gradle.
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@ac638b010cf58a27ee6c972d7336334ccaf61c96 # v4.4.1
        with:
          # Cache only updated on release.
          cache-read-only: true

      # Set up a Node environment for JS/TS/Node client generation.
      - name: Set up Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22

      - name: Assemble code
        run: ./gradlew assemble
        env:
          GITHUB_TOKEN: ${{ secrets.GH_REGISTRY_GRADLE_TOKEN }}
          GRADLE_READ_KEY: ${{ secrets.GH_REGISTRY_GRADLE_TOKEN }}
          JOB_RUNR_REPO_PASSWORD: ${{ secrets.JOB_RUNR_REPO_PASSWORD }}

      # Build tag for feature image
      - name: Build image tag
        id: image-tag
        run: |
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          IMAGE_TAG="feature-${HEAD_SHA::8}"
          echo "result=${IMAGE_TAG}"  >> "$GITHUB_OUTPUT"

      # Build Docker image and cache Docker image/layers.
      - name: Build Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          tags: ${{ steps.image-tag.outputs.result }}
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: github_sha=${{ steps.image-tag.outputs.result }}

      - name: Push to shared-services ECR
        uses: pleo-io/actions/push-shared-services-ecr@a1823de95eb3a28e85630b0d01db59a1b72e2942 # v19.17.5
        with:
          application_name: ${{ github.event.repository.name }}
          image_tag: ${{ steps.image-tag.outputs.result }}

  deploy-feature:
    name: Deploy feature branch
    if: contains(github.event.pull_request.labels.*.name, 'feature-deploy') && !contains(github.event.pull_request.labels.*.name, 'feature-deploy-delete')
    needs:
      - build-and-publish-image
    timeout-minutes: 20
    runs-on: ubuntu-latest-private
    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Create flux manifest directory
        run: |
          mkdir flux-manifest

      # Create helmRelease manifest
      - name: Generate feature deploy manifest for Flux
        id: flux-manifest
        uses: mikefarah/yq@master
        with:
          cmd: >
            yq eval '
              .metadata.name = "${{ env.RELEASE_NAME }}" |
              .metadata.namespace = "${{ github.event.repository.name }}" |
              .spec.values.replicas = 1 |
              .spec.values.imageTag = "${{ needs.build-and-publish-image.outputs.image-tag }}" |
              .spec.values.applicationName = "${{ github.event.repository.name }}"
            ' k8s/${{env.CLUSTER}}/application-${{ github.event.repository.name }}.yaml
            >> flux-manifest/${{ env.RELEASE_NAME }}.yaml

      - name: Configure product-dev AWS credentials
        uses: aws-actions/configure-aws-credentials@b47578312673ae6fa5b5096b330d9fbac3d116df # v4.2.1
        with:
          role-to-assume: ${{ env.PRODUCT_DEV_AWS_IAM_ROLE_TO_ASSUME }}
          role-session-name: GitHubActions
          aws-region: eu-west-1
          special-characters-workaround: true

      # Upload helmRelease manifest file to S3 feature bucket
      - name: Deploy manifest to bucket
        run: |
          aws s3 cp flux-manifest/ s3://pleo-flux-feature-deployment.${{ env.CLUSTER }}/${{ github.event.repository.name }}/ --recursive

      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          issue-number: ${{ github.event.number }}
          body: |
            <h3>:sparkles: Your PR is being deployed in the `${{ env.REPO }}` namespace of the ${{env.CLUSTER}} cluster! :sparkles:</h3>
            <ul>
              <li>:shinto_shrine: Accessible *outside* the cluster via: https://${{ env.RELEASE_NAME }}.${{env.SUB_DOMAIN}}/rest</li>
              <li>:shinto_shrine: Accessible *inside* the cluster via: http://${{ env.RELEASE_NAME }}.${{ env.REPO }}/rest</li>
              <li>:fax: View logs in Grafana <a href="https://pleo.grafana.net/a/grafana-lokiexplore-app/explore/cluster/${{ env.CLUSTER }}/logs?from=now-30m&to=now&var-ds=pleo-grafana-logs-main&var-filters=cluster%7C%3D%7C__CV%CE%A9__${{ env.CLUSTER }},${{ env.CLUSTER }}&var-filters=service_name%7C%3D%7C${{ env.RELEASE_NAME }}&var-fields=&var-levels=&patterns=%5B%5D&var-metadata=service_version%7C%3D%7C${{ needs.build-and-publish-image.outputs.image-tag }}&var-patterns=&var-lineFilterV2=&var-lineFilters=&urlColumns=%5B%5D&visualizationType=%22logs%22&displayedFields=%5B%5D&var-labelBy=$__all&var-fieldBy=$__all&timezone=utc&var-all-fields=service_version%7C%3D%7C${{ needs.build-and-publish-image.outputs.image-tag }}&sortOrder=%22Descending%22&wrapLogMessage=false">here</a></li>
            </ul>
