# THIS CODE WAS AUTOGENERATED. DO NOT MODIFY THIS FILE DIRECTLY
# THE SOURCE CODE LIVES IN A DIFFERENT REPOSITORY:
#   - centralized-templates
# FILE STEWARD: @pleo-io/team-product-led-tooling


name: Trigger revert dev deploy on product-dev
on:
  pull_request:
    types:
      - labeled

concurrency: ci-${{ github.workflow }}-${{ github.ref }}

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  revert-to-stable-version:
    name: Revert product-dev to stable version
    runs-on: ubuntu-latest
    if: ${{ github.event.label.name == 'dev-deploy-revert' }}
    steps:
      - name: Allow pushing version updates to the default branch
        id: get-admin-token
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2
        with:
          app-id: ${{ secrets.PLEO_GH_APP_TOKEN_SIGNER_APP_ID }}
          private-key: ${{ secrets.PLEO_GH_APP_TOKEN_SIGNER_PRIVATE_KEY }}

      # Checkout the code with the elevated token to allow default branch pushes.
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          token: ${{ steps.get-admin-token.outputs.token }}
          ref: ${{ github.event.repository.default_branch }}

      - name: Pull stable Helm release file
        run: |
          git pull --tags
          git show tags/product-dev-stable:k8s/product-dev/application-${{ github.event.repository.name }}.yaml > k8s/product-dev/application-${{ github.event.repository.name }}.yaml

      - name: Commit stable Helm release
        uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5 # v9.1.4
        with:
          author_name: github-actions[bot]-ci
          author_email: github-actions@pleo.io
          message: "Reverting product-dev deployment for branch [${{ github.event.pull_request.head.ref }}] [skip-ci]"
          add: k8s/product-dev/application-${{ github.event.repository.name }}.yaml
          commit: --no-verify
