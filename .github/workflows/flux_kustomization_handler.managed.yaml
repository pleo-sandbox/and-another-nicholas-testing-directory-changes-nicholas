# THIS CODE WAS AUTOGENERATED. DO NOT MODIFY THIS FILE DIRECTLY
# THE SOURCE CODE LIVES IN A DIFFERENT REPOSITORY:
#   - centralized-templates
# FILE STEWARD: @pleo-io/infrastructure-core


# This is managed by SRE and should not be touched, this is what maps a flux notification to our own domain
name: Flux Kustomization handler
run-name: "Incoming dispatch: ${{ github.event.action }}"
on: repository_dispatch

jobs:
  translate-event:
    runs-on: ubuntu-latest
    if: contains(github.event.action, 'Kustomization/app') && github.event.client_payload.severity == 'info'
    steps:
      # How we get the SHA (SHA=${revision##*:})
      # revision has the following format: main@sha1:3f01d704a07a0f9f55d5555a02c7e0a65b961fa7
      # We just need the SHA, so we need to drop anything before and including the ':'
      # the '##'' greedily removes the subsequent pattern off the front
      # the '*:'' matches anything followed by a /
      - name: Prepare
        id: prep
        run: |
          revision=${{ github.event.client_payload.metadata.revision }}
          SHA=${revision##*:}   
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          ref: ${{ steps.prep.outputs.sha }}

      - name: Get environment
        id: environment
        uses: mikefarah/yq@b534aa9ee5d38001fba3cd8fe254a037e4847b37 # v4.45.4
        with:
          cmd: echo "${{ github.event.client_payload.metadata.summary }}" | yq '.environment'

      - name: Get image tag
        id: tag
        uses: mikefarah/yq@b534aa9ee5d38001fba3cd8fe254a037e4847b37 # v4.45.4
        with:
          cmd: yq '.spec.values.imageTag' k8s/${{ steps.environment.outputs.result }}/application-${{ github.event.repository.name }}.yaml

      - name: Determine author
        id: determine_author
        run: |
          AUTHOR="$(git log -1 --pretty=format:'%an' | xargs -0)"
          echo "$AUTHOR"
          echo "author=$AUTHOR" >> "$GITHUB_OUTPUT"

      - name: Add manual payload on the event
        id: trigger
        run: |
          # github-actions[bot]-ci - automated commit changing image tag
          # pleo-bot-auto-versioning - automated commit updating CHANGELOG
          if [ "${{ steps.determine_author.outputs.author }}" = "github-actions[bot]-ci" ] || [ "${{ steps.determine_author.outputs.author }}" = "pleo-bot-auto-versioning" ]; then
              echo "source=ci" >> "$GITHUB_OUTPUT"
          else
              echo "source=manual" >> "$GITHUB_OUTPUT"
          fi

      - name: Repository dispatch
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3
        with:
          event-type: deployed
          client-payload: '{"environment": "${{ steps.environment.outputs.result }}", "image_tag": "${{ steps.tag.outputs.result }}","trigger":"${{steps.trigger.outputs.source}}"}'
